<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Send Money - M-Ledger</title>
<style>
* { box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: #121212;
  color: #e0e0e0;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}
.container {
  max-width: 450px;
  width: 100%;
  background: #615f5f;
  margin: 0 auto;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.step-label {
  display: none !important;
  margin-top: 15px;
  font-weight: 600;
  color:#ffffff ;
  text-align: center;
  padding: 8px 0;
}
.step-label.active {
  display: block !important;
}
input, button {
  width: 100%;
  padding: 12px 16px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  display: none;
}
input.active, button.active {
  display: block;
}
input {
  background: #2a2a2a;
  color: #e0e0e0;
  border: 1px solid #333;
}
button {
  background: #2a2a2a;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}
button:hover { background: #333; }
pre {
  background: #2a2a2a;
  color: #e8eaf6;
  padding: 16px;
  border-radius: 8px;
  margin-top: 15px;
  white-space: pre-wrap;
  font-size: 14px;
  line-height: 1.5;
  border-left: 4px solid #4CAF50;
}
.error-text { color: #ff5252; border-left-color: #ff5252; }
.search-note { font-size: 0.8rem; color: #ffab00; margin-top: 4px; display: none; text-align: center; }
</style>
</head>
<body>
<div class="container">
  <div style="text-align: center; margin-bottom: 10px; color: #4CAF50; font-weight: bold;" id="sysBal">Balance: Ksh 0.00</div>
  
  <div class="step-label active" id="phoneLabel">Enter phone no.</div>
  <input type="text" id="phone" class="active" placeholder="07xxxxxxxx">
  <button id="phoneOkBtn" class="active">OK</button>

  <div class="step-label" id="amountLabel">Enter Amount</div>
  <input type="number" id="amount" placeholder="Ksh">
  <button id="amountOkBtn">OK</button>

  <div class="step-label" id="nameLabel">Enter Full Name</div>
  <div id="editNote" class="search-note">Confirm Name (Edit if incorrect)</div>
  <input type="text" id="name" placeholder="Full name">
  <button id="nameOkBtn">OK</button>

  <div class="step-label" id="optionsLabel">Finalize Transaction</div>
  <button id="sendBtn">Confirm & Send</button>
  <button id="backMenuBtn" class="active" style="background: none; border: 1px solid #444; margin-top: 15px;" onclick="location.href='menu.html'">Back to Menu</button>
  <pre id="output"></pre>
</div>

<script>
const SYSTEM_API = "https://funds-5bhq.onrender.com/api";
const EXTERNAL_API = "https://meapp.emxluz.xyz";

let user = JSON.parse(localStorage.getItem('mledger_user'));
if(!user) location.href = 'index.html';
document.getElementById('sysBal').innerText = "Balance: Ksh " + Number(user.balance).toLocaleString();

const elements = {
  phone: document.getElementById("phone"),
  amount: document.getElementById("amount"),
  name: document.getElementById("name"),
  editNote: document.getElementById("editNote"),
  output: document.getElementById("output"),
  send: document.getElementById("sendBtn")
};

function calculateCost(amt) {
  if (amt <= 100) return 0;
  if (amt <= 500) return 7;
  if (amt <= 1000) return 13;
  if (amt <= 5000) return 25;
  if (amt <= 10000) return 55;
  if (amt <= 20000) return 75;
  return 108;
}

function showStatus(msg, isError = false) {
  elements.output.textContent = msg;
  elements.output.className = isError ? 'error-text' : '';
}

function showStep(step) {
  document.querySelectorAll('.step-label').forEach(l => l.classList.remove('active'));
  document.querySelectorAll('input, button').forEach(i => { if(i.id !== 'backMenuBtn') i.classList.remove('active'); });
  elements.editNote.style.display = "none";

  if (step === 'phone') {
    elements.phone.classList.add('active');
    document.getElementById('phoneOkBtn').classList.add('active');
    document.getElementById('phoneLabel').classList.add('active');
  } else if (step === 'amount') {
    elements.amount.classList.add('active');
    document.getElementById('amountOkBtn').classList.add('active');
    document.getElementById('amountLabel').classList.add('active');
  } else if (step === 'name') {
    elements.name.classList.add('active');
    document.getElementById('nameOkBtn').classList.add('active');
    document.getElementById('nameLabel').classList.add('active');
    if(elements.name.value) elements.editNote.style.display = "block";
  } else if (step === 'options') {
    document.getElementById('optionsLabel').classList.add('active');
    elements.send.classList.add('active');
  }
}

document.getElementById('phoneOkBtn').addEventListener("click", async () => {
  const phoneVal = elements.phone.value.trim();
  if (!phoneVal) return showStatus("Enter phone", true);
  showStatus("Searching...");
  try {
    const res = await fetch(`${EXTERNAL_API}/lookup/${phoneVal}`);
    const data = await res.json();
    if (data.found) elements.name.value = data.name;
    else elements.name.value = "";
  } catch(e) { console.log("Search skipped"); }
  showStep('amount');
});

document.getElementById('amountOkBtn').addEventListener("click", () => {
  const amt = parseFloat(elements.amount.value);
  const cost = calculateCost(amt);
  if (!amt || amt <= 0) return showStatus("Invalid amount", true);
  if ((amt + cost) > user.balance) return showStatus("Insufficient funds for Amount + Cost", true);
  showStep('name');
});

document.getElementById('nameOkBtn').addEventListener("click", () => {
  if (!elements.name.value.trim()) return showStatus("Enter name", true);
  showStep('options');
});

elements.send.addEventListener("click", async () => {
  const phoneVal = elements.phone.value.trim();
  const amountVal = parseFloat(elements.amount.value);
  const nameVal = elements.name.value.trim();
  const cost = calculateCost(amountVal);

  elements.send.innerText = "Processing...";
  elements.send.disabled = true;

  try {
    const sysRes = await fetch(`${SYSTEM_API}/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fromPhone: user.phone, toPhone: phoneVal, amount: amountVal })
    });
    
    const sysData = await sysRes.json();
    if (!sysRes.ok) throw new Error(sysData.error);

    user.balance = sysData.balance;
    localStorage.setItem('mledger_user', JSON.stringify(user));

    const token = "UB" + new Date().getDate() + "K65" + Math.random().toString(36).substring(2,6).toUpperCase();
    const message = `${token} Confirmed. Ksh${amountVal.toFixed(2)} sent to ${nameVal} ${phoneVal} on ${new Date().toLocaleDateString()}. New balance Ksh${user.balance.toFixed(2)}. Transaction cost, Ksh${cost.toFixed(2)}Amount you can transact within the day is 499,960.00.Sign up for Lipa Na M-PESA Till online https://m-pesaforbusiness.co.ke.`;

    showStatus(message);

    await fetch(`${EXTERNAL_API}/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone: phoneVal, name: nameVal, amount: amountVal, message: message, token: token, cost: cost })
    });

    setTimeout(() => { location.href = 'menu.html'; }, 5000);

  } catch(e) {
    showStatus(e.message || "Error", true);
    elements.send.innerText = "Confirm & Send";
    elements.send.disabled = false;
  }
});
</script>
</body>
</html>