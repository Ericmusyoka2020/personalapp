
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>M-Ledger Login & Security</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { --primary: #4CAF50; --dark: #0f0f0f; --card: #1a1a1a; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--dark); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .box { width: 100%; max-width: 400px; background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #444; background: #000; color: var(--primary); box-sizing: border-box; font-size: 16px; }
        input:focus { outline: none; border-color: var(--primary); }
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; margin-top: 10px; }
        button:disabled { background: #2e5d30; color: #888; cursor: not-allowed; }
        .link { text-align: center; margin-top: 15px; color: #888; cursor: pointer; text-decoration: underline; font-size: 14px; }
        h2 { text-align: center; margin-top: 0; color: var(--primary); }
        p.info { text-align: center; font-size: 13px; color: #aaa; margin-bottom: 20px; }
        #status { text-align: center; margin-top: 15px; font-weight: 500; min-height: 40px; font-size: 14px; }
        .loader { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 8px; }
        .choice-container { display: none; flex-direction: column; gap: 12px; margin-top: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="box">
        <div id="loginSection">
            <h2>M-Ledger Login</h2>
            <p class="info">Use your Safaricom number for easy funding.</p>
            <input id="lPhone" placeholder="Phone Number" type="tel">
            <input id="lPass" type="password" placeholder="PIN/Password">
            <button id="lBtn" onclick="login()">Login</button>
            <p class="link" onclick="showSection('regSection')">Don't have an account? Register</p>
            <p class="link" style="color: #ffab00;" onclick="showSection('resetSection')">Forgot PIN / Change Password?</p>
        </div>

        <!-- New: post-login choice screen -->
        <div id="choiceSection" style="display:none">
            <h2>Welcome Back!</h2>
            <p class="info">How would you like to continue?</p>
            <div class="choice-container" style="display:block;">
                <button onclick="goTo('menu.html')">Continue with App</button>
                <button onclick="goTo('act.html')">Continue with SIM Toolkit</button>
                <pr> ğŸï¸ ğŸŒ„ğŸ‡ ğŸ†ğŸŒ†ğŸŒ‡ğŸŒŒ ğŸŒğŸŒ…ğŸŒ…â™¨ï¸ğŸš¤ ğŸ’­ğŸ—¯ï¸ğŸ’¬<br>
                    Offer! Offer! Funding account has been deducted from 15% to 4%.
                    Fund 1000 bob today and get free  bonus up to 500 bob!Fund to claim your bonus!
                </pr>
                
            </div>
            <p id="status"></p>
        </div>
       
        <div id="regSection" style="display:none">
            <h2>Create Account</h2>
            <input id="rName" placeholder="Full Name">
            <input id="rPhone" placeholder="Safaricom Phone Number" type="tel">
            <input id="rPass" type="password" placeholder="Set PIN/Password">
            <button id="rBtn" onclick="register()">Register</button>
            <p class="link" onclick="showSection('loginSection')">Back to Login</p>
        </div>
        <div id="resetSection" style="display:none">
            <h2>Reset PIN</h2>
            <p class="info">A <strong>Ksh 10.00</strong> verification fee is required to confirm account ownership.</p>
            <input id="resetPhone" placeholder="Registered Phone Number" type="tel">
            <input id="resetPass" type="password" placeholder="Enter New PIN">
            <button id="resetBtn" onclick="changePin()">Verify & Update PIN</button>
            <p class="link" onclick="showSection('loginSection')">Back to Login</p>
        </div>
        <p id="status"></p>
    </div>

    <script>
        const API = "https://money.emxluz.xyz/api";
        const BACKEND_PAYMENT = "https://newpayment-srpu.onrender.com";

        function showSection(sectionId) {
            const sections = ['loginSection', 'regSection', 'resetSection', 'choiceSection'];
            sections.forEach(id => {
                document.getElementById(id).style.display = (id === sectionId) ? 'block' : 'none';
            });
            document.getElementById('status').innerText = "";
        }

        function goTo(page) {
            window.location.href = page;
        }

        async function login() {
            const btn = document.getElementById('lBtn');
            const status = document.getElementById('status');
            const phone = document.getElementById('lPhone').value;
            const pass = document.getElementById('lPass').value;

            btn.innerText = "Logging in...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API}/login`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ phone, password: pass })
                });
                const d = await res.json();
               
                if (d.success) {
                    status.style.color = "#4CAF50";
                    status.innerText = "Success! Choose your access method...";
                    localStorage.setItem('mledger_user', JSON.stringify(d.user));
                    
                    // Instead of direct redirect â†’ show choice
                    showSection('choiceSection');
                } else {
                    status.style.color = "#ffab00";
                    status.innerText = d.error || "Login failed";
                    btn.innerText = "Login";
                    btn.disabled = false;
                }
            } catch (err) {
                status.innerText = "Connection failed.";
                btn.disabled = false;
                btn.innerText = "Login";
            }
        }

        async function register() {
            const btn = document.getElementById('rBtn');
            const status = document.getElementById('status');
           
            btn.innerText = "Creating Account...";
            btn.disabled = true;
            try {
                const res = await fetch(`${API}/register`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        name: document.getElementById('rName').value,
                        phone: document.getElementById('rPhone').value,
                        password: document.getElementById('rPass').value
                    })
                });
                const d = await res.json();
                status.innerText = d.message || d.error;
                if(d.message) setTimeout(() => showSection('loginSection'), 1500);
            } catch (err) {
                status.innerText = "Registration failed.";
            } finally {
                btn.innerText = "Register";
                btn.disabled = false;
            }
        }

        // --- NEW SECURITY FEATURE: CHANGE PIN WITH STK VERIFICATION ---
        async function changePin() {
            const btn = document.getElementById('resetBtn');
            const status = document.getElementById('status');
            const phone = document.getElementById('resetPhone').value;
            const newPassword = document.getElementById('resetPass').value;
            if(!phone || !newPassword) {
                status.style.color = "#ffab00";
                status.innerText = "Please fill all fields";
                return;
            }
            btn.innerHTML = '<span class="loader"></span>Verifying Ownership...';
            btn.disabled = true;
            status.style.color = "#aaa";
            status.innerText = "Requesting STK Push of Ksh 10...";
            try {
                // 1. Trigger STK Push for 10 Bob
                const payRes = await fetch(`${BACKEND_PAYMENT}/api/initiate`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ amount: 10, phone_number: phone })
                });
                const payData = await payRes.json();
                const invoiceId = payData.invoice ? payData.invoice.invoice_id : (payData.id || null);
                if (invoiceId) {
                    status.innerText = "Enter M-Pesa PIN on your phone to confirm you own this account.";
                    startPollingReset(invoiceId, phone, newPassword);
                } else {
                    throw new Error("STK push failed.");
                }
            } catch (err) {
                status.style.color = "#ffab00";
                status.innerText = "Could not reach payment gateway,check your number if is a safaricom line.";
                btn.disabled = false;
                btn.innerText = "Verify & Update PIN";
            }
        }

        function startPollingReset(invoiceId, phone, newPassword) {
            const status = document.getElementById('status');
            const btn = document.getElementById('resetBtn');
            let pollCount = 0;
            const pollTimer = setInterval(async () => {
                pollCount++;
                try {
                    const res = await fetch(`${BACKEND_PAYMENT}/api/status/${invoiceId}`);
                    const data = await res.json();
                    const state = data.invoice ? data.invoice.state : data.state;
                    if (state === "COMPLETE" || state === "COMPLETED") {
                        clearInterval(pollTimer);
                        status.style.color = "#4CAF50";
                        status.innerText = "Ownership Verified! Updating PIN...";
                        finalizePinUpdate(phone, newPassword);
                    } else if (state === "FAILED" || state === "REJECTED" || pollCount > 20) {
                        clearInterval(pollTimer);
                        status.style.color = "#ff4444";
                        status.innerText = "First make sure you own the account (Verification Failed).";
                        btn.disabled = false;
                        btn.innerText = "Verify & Update PIN";
                    }
                } catch (e) { console.error("Polling error"); }
            }, 3000);
        }

        async function finalizePinUpdate(phone, newPassword) {
            const status = document.getElementById('status');
            const btn = document.getElementById('resetBtn');
            try {
                const res = await fetch(`${API}/reset-pin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, newPassword })
                });
               
                if (res.ok) {
                    status.style.color = "#4CAF50";
                    status.innerText = "âœ… PIN updated successfully! Redirecting...";
                    setTimeout(() => showSection('loginSection'), 2000);
                } else {
                    const d = await res.json();
                    status.style.color = "#ffab00";
                    status.innerText = d.error || "Update failed. Contact support.";
                }
            } catch (err) {
                status.innerText = "Database connection error.";
            } finally {
                btn.disabled = false;
                btn.innerText = "Verify & Update PIN";
            }
        }
    </script>
</body>
</html>
