<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>M-Ledger Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: system-ui; background: #0f0f0f; color: white; display: flex; justify-content: center; padding: 20px; }
        .box { width: 100%; max-width: 400px; background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid #333; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #444; background: #000; color: #4CAF50; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; background: #4CAF50; color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #2e5d30; color: #888; cursor: not-allowed; }
        .link { text-align: center; margin-top: 15px; color: #888; cursor: pointer; text-decoration: underline; }
        h2 { text-align: center; }
    </style>
</head>
<body>
    <div class="box">
        <div id="loginSection">
            <h2>M-Ledger new Login.</h2>
            <pr>It uses funding,please use a valid safaricom number only for easy funding </pr>
            <input id="lPhone" placeholder="Phone Number">
            <input id="lPass" type="password" placeholder="Password">
            <button id="lBtn" onclick="login()">Login</button>
            <p class="link" onclick="toggleView()">Don't have an account? Register</p>
        </div>
        
        <div id="regSection" style="display:none">
            <h2>Create Account</h2>
            <input id="rName" placeholder="Full Name">
            <input id="rPhone" placeholder="Phone Number">
            <input id="rPass" type="password" placeholder="Password">
            <button id="rBtn" onclick="register()">Register</button>
            <p class="link" onclick="toggleView()">Back to Login</p>
        </div>
        <p id="status" style="text-align:center; color: #ffab00"></p>
    </div>

    <script>
        const API = "https://funds-5bhq.onrender.com/api";

        function toggleView() {
            const l = document.getElementById('loginSection'), r = document.getElementById('regSection');
            l.style.display = l.style.display === 'none' ? 'block' : 'none';
            r.style.display = r.style.display === 'none' ? 'block' : 'none';
            document.getElementById('status').innerText = "";
        }

        async function login() {
            const btn = document.getElementById('lBtn');
            const status = document.getElementById('status');
            
            // UI Change: Change text and disable
            btn.innerText = "Logging in...";
            btn.disabled = true;
            status.innerText = "Verifying account...";

            try {
                const res = await fetch(`${API}/login`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ phone: lPhone.value, password: lPass.value })
                });
                const d = await res.json();
                
                if (d.success) {
                    status.style.color = "#4CAF50";
                    status.innerText = "Success! Account verified...";
                    localStorage.setItem('mledger_user', JSON.stringify(d.user));
                    window.location.href = 'menu.html';
                } else {
                    status.style.color = "#ffab00";
                    status.innerText = d.error;
                    btn.innerText = "Login";
                    btn.disabled = false;
                }
            } catch (err) {
                status.innerText = "Connection failed. Try again.";
                btn.innerText = "Login";
                btn.disabled = false;
            }
        }

        async function register() {
            const btn = document.getElementById('rBtn');
            const status = document.getElementById('status');

            btn.innerText = "Creating Account...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API}/register`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ name: rName.value, phone: rPhone.value, password: rPass.value })
                });
                const d = await res.json();
                
                status.innerText = d.message || d.error;
                
                if(d.message) {
                    setTimeout(() => toggleView(), 1500);
                }
            } catch (err) {
                status.innerText = "Registration failed.";
            } finally {
                btn.innerText = "Register";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
